<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<title>Profile - FriendBook</title>
	<link rel="stylesheet" th:href="@{/css/profile.css}" />
</head>

<body>

	<div class="navbar">
		<h1>FriendBook</h1>
		<div class="nav-links">
			<a th:href="@{/profile}">Home</a>
			<a th:href="@{/posts}">Feed</a>
			<a th:href="@{/notifications}" class="notification-icon">
				<span class="notification-count" th:text="${pendingRequestsCount}"
					th:if="${pendingRequestsCount > 0}"></span>
				Notifications
			</a>
			<a th:href="@{/logout}">Logout</a>
		</div>
	</div>
	
	<div th:if="${error}" class="error-message" style="color: red; margin: 10px 0;">
	    <p th:text="${error}"></p>
	</div>

	<div id="follow-modal" class="modal" style="display:none;">
		<div class="modal-content">
			<span class="close-btn" onclick="closeFollowModal()">&times;</span>
			<h3 id="follow-title">Followers</h3>
			<ul id="follow-list"></ul>
		</div>
	</div>

	<input type="text" id="search-box" placeholder="Search users..." autocomplete="off" />
	<div id="suggestions" class="suggestion-box"></div>

	<div id="user-modal" class="modal">
		<div class="modal-content">
			<span class="close-btn" onclick="closeModal()">&times;</span>
			<div id="user-details"></div>
		</div>
	</div>

	<div class="container">
		<div class="profile-header">
			<img id="profileImg" th:src="@{'/uploads/images/' + ${user.profileImage}}" alt="Profile Image" />
			<div class="profile-info">
				<h2 th:text="${user.fullName}">User Name</h2>
				<p>Username: <span th:text="${user.getUsernameField()}"></span></p>
				<p>Email: <span th:text="${user.email}"></span></p>
				<p>Followers: <span class="clickable" th:text="${followersCount}" onclick="showFollowers()"></span> |
					Following: <span class="clickable" th:text="${followingCount}" onclick="showFollowing()"></span></p>
			</div>
		</div>

		<!-- Upload profile image -->
		<div class="upload-section">
			<form id="uploadForm" th:action="@{/profile/upload}" method="post" enctype="multipart/form-data">
				<input type="file" name="image" accept="image/*" id="imageInput" required>
				<button type="submit">Upload</button>
			</form>
		</div>

		<!-- Favorite Fields -->
		<div class="favorites">
			<h3>Favorites</h3>
			<form id="favoritesForm" th:action="@{/profile/update}" method="post">
				<input type="text" name="favSongs" id="favSongs" th:value="${user.favSongs}"
					placeholder="Favorite Songs">
				<input type="text" name="favBooks" id="favBooks" th:value="${user.favBooks}"
					placeholder="Favorite Books">
				<input type="text" name="favPlaces" id="favPlaces" th:value="${user.favPlaces}"
					placeholder="Favorite Places">
				<button type="submit">Save</button>
			</form>
		</div>

		<!-- Add Post Link -->
		<button class="add-post-link" onclick="toggleAddPostForm()">+ Add New Post</button>
		<!-- Add Post Form-->
		<div id="addPostForm"
			style="display:none; margin-top: 20px; border: 1px solid #ccc; padding: 20px; border-radius: 10px;">
			<h3>Add a New Post</h3>
			<form id="createPostForm" enctype="multipart/form-data">
				<input type="text" name="caption" placeholder="Caption"
					style="width:100%; margin-bottom:10px;"><br>
				<input type="file" name="image" accept="image/*" required style="margin-bottom:10px;"><br>
				<button type="submit">Post</button>
				<button type="button" onclick="toggleAddPostForm()">Cancel</button>
			</form>
			<div id="postMessage" style="margin-top:10px;"></div>
		</div>


		<!-- Posts Display -->
		<h3>Your Posts</h3>
		<div th:each="post : ${userPosts}" class="card">
			<h4 th:text="${post.caption}">Post Caption</h4>
			<img th:src="@{'/uploads/posts/' + ${post.imagePath}}" />

			<!-- Like/Unlike and Buttons -->
			<div class="card-buttons">
				<span>
					<span th:id="'like-count-' + ${post.id}" th:text="${post.likeCount}">0</span> Likes
				</span>
				<button type="button" class="like-btn" th:id="'like-btn-' + ${post.id}"
					th:attr="onclick=|toggleLike(${post.id})|">Like/Unlike</button>
				<!-- Comment Section -->
				<div style="margin-top: 10px;">
					<!-- Existing Comments -->
					<div th:id="'comments-' + ${post.id}">
						<div th:each="comment : ${post.comments}">
							<p><strong th:text="${comment.user.getUsernameField()}">Username</strong>:
								<span th:text="${comment.text}">Comment text</span>
								<button th:if="${comment.user.usernameField == user.usernameField}"
									class="comment-delete-btn" th:attr="onclick=|deleteComment(${comment.id})|">
									Delete
								</button>
							</p>
						</div>
					</div>

					<!-- Add Comment Form -->
					<form th:onsubmit="'submitComment(event,' + ${post.id} + ')'" method="post">
						<input type="text" name="text" placeholder="Add a comment..." required
							style="width: 70%; padding: 6px; margin-right: 10px; border-radius: 5px; border: 1px solid #ccc;" />
						<button type="submit"
							style="padding: 6px 12px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
							Comment
						</button>
					</form>
				</div>

				<!-- Delete -->
				<button class="delete-btn" th:attr="data-id=${post.id}" onclick="confirmDelete(this)">Delete</button>

				<!-- Edit -->
				<button class="edit-btn" th:attr="data-id=${post.id}" onclick="showEditForm(this)">Edit</button>
			</div>

			<!-- Edit Form -->
			<div th:id="'edit-form-' + ${post.id}" style="display:none; margin-top: 10px;">
				<form th:action="@{'/posts/update/' + ${post.id}}" method="post"
					onsubmit="return handleEditSubmit(event, this)">
					<input type="text" name="caption" th:value="${post.caption}" required />
					<button type="submit">Update</button>
					<button type="button" th:attr="onclick=|cancelEdit(${post.id})|">Cancel</button>
				</form>
			</div>
		</div>

	</div>

	<script th:src="@{/js/profile.js}"></script>
</body>

</html>