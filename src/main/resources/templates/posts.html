<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<title>Feed - FriendBook</title>
	<meta name="username" th:content="${#authentication.name}">

	<style>
		:root {
			--primary: #007bff;
			--bg: #f0f2f5;
			--card-bg: #ffffff;
			--text-dark: #333;
		}

		body {
			margin: 0;
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background-color: var(--bg);
		}

		.navbar {
			background-color: var(--card-bg);
			padding: 15px 30px;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.navbar h1 {
			margin: 0;
			font-size: 24px;
			color: var(--text-dark);
		}

		.nav-links a {
			text-decoration: none;
			color: var(--text-dark);
			margin-left: 20px;
			font-weight: 500;
		}

		.container {
			max-width: 1100px;
			margin: 30px auto;
			padding: 20px;
		}

		.grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
			gap: 20px;
		}

		.card {
			background: var(--card-bg);
			border: 1px solid #ddd;
			border-radius: 10px;
			padding: 15px;
			box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
		}

		.card img {
			width: 100%;
			height: auto;
			border-radius: 8px;
		}

		.card h3 {
			margin: 10px 0;
			color: var(--text-dark);
		}

		.meta {
			font-size: 14px;
			color: #666;
		}

		.like-section,
		.comment-form {
			margin-top: 10px;
		}

		.like-section button,
		.comment-form button {
			background-color: var(--primary);
			color: #fff;
			border: none;
			padding: 6px 12px;
			border-radius: 5px;
			cursor: pointer;
			margin-top: 5px;
		}

		.comment-form input[type="text"] {
			width: 100%;
			padding: 6px;
			border-radius: 5px;
			border: 1px solid #ccc;
			margin-bottom: 6px;
		}

		.comments {
			margin-top: 10px;
		}

		.comment {
			font-size: 14px;
			margin-bottom: 4px;
			color: #444;
		}

		.comment b {
			color: #000;
		}

		.back-link {
			display: inline-block;
			margin-top: 20px;
			color: var(--primary);
			font-weight: bold;
			text-decoration: none;
		}
	</style>
</head>

<body>
	<!-- Navbar -->
	<div class="navbar">
		<h1>FriendBook</h1>
		<div class="nav-links">
			<a th:href="@{/profile}">Profile</a>
			<a th:href="@{/logout}">Logout</a>
		</div>
	</div>

	<!-- Posts -->
	<div class="container">
		<h2>Feed - Posts from People You Follow</h2>
		<div class="grid">
			<div th:each="post : ${posts}" class="card">
				<h3 th:text="${post.caption}">Caption</h3>
				<img th:src="@{'/posts/' + ${post.imagePath}}" alt="Post Image" />
				<p class="meta">
					Posted by <b th:text="${post.user.getUsernameField()}">Username</b><br>
					<span th:text="${#temporals.format(post.createdAt, 'dd-MM-yyyy HH:mm')}">Date</span>
				</p>

				<!-- Like Section -->
				<div class="like-section">
					<span th:id="'like-count-' + ${post.id}" th:text="${post.likeCount}">0</span> Likes
					<button type="button" th:id="'like-btn-' + ${post.id}" th:attr="onclick=|toggleLike(${post.id})|">
						Like/Unlike
					</button>
				</div>

				<!-- Display comments -->
				<!-- Comments Section -->
				<div th:id="'comments-' + ${post.id}">
					<div th:each="comment : ${post.comments}">
						<p><b th:text="${comment.user.getUsernameField()}"></b>:
							<span th:text="${comment.text}"></span>
						</p>
					</div>
				</div>

				<!-- Comment Form (AJAX) -->
				<form th:onsubmit="|submitComment(event, ${post.id})|">
					<input type="text" name="text" placeholder="Add a comment" required />
					<button type="submit">Comment</button>
				</form>


			</div>
		</div>

		<a class="back-link" th:href="@{/profile}">&larr; Back to Profile</a>
	</div>

	<!-- Like AJAX Script -->
	<script>
		async function submitComment(event, postId) {
			event.preventDefault();
			const form = event.target;
			const input = form.querySelector('input[name="text"]');
			const text = input.value;

			if (!text.trim()) return;

			const response = await fetch(`/comments/${postId}`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded'
				},
				body: new URLSearchParams({text})
			});

			if (response.ok) {
				const username = document.querySelector("meta[name='username']").getAttribute("content"); // You can also pass it from server

				// Append new comment directly to the DOM
				const commentsDiv = document.getElementById(`comments-${postId}`);
				const newComment = document.createElement('p');
				newComment.innerHTML = `<b>${username}</b>: ${text}`;
				commentsDiv.appendChild(newComment);

				input.value = '';
			} else {
				alert("Failed to post comment");
			}
		}

		async function loadComments(postId) {
			const res = await fetch(`/api/comments/${postId}`);
			if (res.ok) {
				const comments = await res.json();
				const commentDiv = document.getElementById(`comments-${postId}`);
				commentDiv.innerHTML = "";
				comments.forEach(c => {
					const p = document.createElement("p");
					p.innerHTML = `<b>${c.user.username}</b>: ${c.text}`;
					commentDiv.appendChild(p);
				});
			}
		}
		async function toggleLike(postId) {
			const res = await fetch(`/api/likes/${postId}`, {method: 'POST'});
			if (res.ok) {
				const newCount = await res.text();
				document.getElementById(`like-count-${postId}`).innerText = newCount;
			} else {
				alert("Failed to like/unlike");
			}
		}
	</script>
</body>

</html>